<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ÁµÇÊ•µ Sudoku ÈÅäÊà≤</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      background: #1a1a1a;
      color: white;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .light {
      background: #f0f0f0;
      color: #222;
    }
    .top-bar {
      width: 100%;
      text-align: center;
      padding: 10px;
    }
    .controls button, select {
      padding: 6px 10px;
      margin: 3px;
      font-size: 16px;
      cursor: pointer;
    }
    #sudoku {
      margin-top: 20px;
      width: 90vw;
      max-width: 500px;
      display: grid;
      grid-template-columns: repeat(9, 1fr);
      border: 4px solid white;
    }
    .cell {
      border: 1px solid #555;
      aspect-ratio: 1;
      font-size: 28px;
      text-align: center;
      background: #333;
      color: white;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .light .cell { background: #fdfdfd; color: black; }
    .fixed {
      background: #444 !important;
      font-weight: bold;
    }
    .light .fixed { background: #ddd !important; }
    .highlight { background: #555 !important; }
    .same-number { background: #6a6 !important; }
    .error { background: #a00 !important; }
    .note { font-size: 12px; opacity: 0.8; }
    #numberPad {
      position: fixed;
      bottom: 20px;
      display: grid;
      grid-template-columns: repeat(5, 50px);
      gap: 5px;
    }
    #numberPad button {
      font-size: 18px;
      padding: 8px;
      cursor: pointer;
    }
    #message {
      margin-top: 10px;
      min-height: 25px;
      font-size: 20px;
    }
    .cell.anim {
      animation: pop 0.15s;
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.22); }
      100% { transform: scale(1); }
    }
    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      background: yellow;
      top: -20px;
      opacity: 0.8;
      pointer-events: none;
    }
    @keyframes fall {
      to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
    }
  </style>
</head>
<body>

  <div class="top-bar">
    <h1>ÁµÇÊ•µÊï∏Áç®</h1>
    <div class="controls">
      <select id="difficulty">
        <option value="40">Á∞°ÂñÆ</option>
        <option value="50">‰∏≠Á≠â</option>
        <option value="60">Âõ∞Èõ£</option>
        <option value="70">Âú∞ÁçÑ</option>
      </select>
      <button id="newGameBtn">Êñ∞ÈÅäÊà≤</button>
      <button id="restartBtn">ÈáçÈñãÊú¨Â±Ä</button>
      <button id="undoBtn">‚Ü∂ Undo</button>
      <button id="redoBtn">‚Ü∑ Redo</button>
      <button id="hintBtn">ÊèêÁ§∫</button>
      <button id="solveBtn">Ëá™ÂãïËß£È°å</button>
      <button id="themeBtn">üåô/‚òÄ</button>
      <span id="timer">00:00</span>
    </div>
  </div>

  <div id="sudoku"></div>

  <div id="numberPad">
    <button class="num">1</button><button class="num">2</button><button class="num">3</button>
    <button class="num">4</button><button class="num">5</button><button class="num">6</button>
    <button class="num">7</button><button class="num">8</button><button class="num">9</button>
    <button id="noteToggle">Á≠ÜË®ò</button>
    <button id="eraseBtn">Ê∏ÖÈô§</button>
  </div>

  <div id="message"></div>

  <script>
    
    let board = [], solution = null;
    let historyStack = [], redoStack = [];
    let selectedCell = null;
    let noteMode = false;
    let errors = 0;
    let timerInterval = null, startTime = null;
    let themeDark = true;



    function makeEmptyBoard() {
      board = Array.from({ length: 9 }, () => Array(9).fill(0));
    }

    function isValid(b, r, c, num) {
      for (let x = 0; x < 9; x++) {
        if (b[r][x] === num) return false;
        if (b[x][c] === num) return false;
      }
      const br = Math.floor(r/3)*3, bc = Math.floor(c/3)*3;
      for (let rr = br; rr < br+3; rr++)
        for (let cc = bc; cc < bc+3; cc++)
          if (b[rr][cc] === num) return false;
      return true;
    }

    function fillBoard(b) {
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (b[r][c] === 0) {
            let nums = [1,2,3,4,5,6,7,8,9].sort(() => Math.random() - 0.5);
            for (let num of nums) {
              if (isValid(b, r, c, num)) {
                b[r][c] = num;
                if (fillBoard(b)) return true;
                b[r][c] = 0;
              }
            }
            return false;
          }
        }
      }
      return true;
    }

    function hasUniqueSolution(b) {
      let count = 0;
      function solve(b2) {
        for (let r = 0; r < 9; r++) {
          for (let c = 0; c < 9; c++) {
            if (b2[r][c] === 0) {
              for (let num = 1; num <= 9; num++) {
                if (isValid(b2, r, c, num)) {
                  b2[r][c] = num;
                  solve(b2);
                  if (count > 1) return;
                  b2[r][c] = 0;
                }
              }
              return;
            }
          }
        }
        count++;
      }
      let copy = b.map(r => r.slice());
      solve(copy);
      return count === 1;
    }

    function generatePuzzle(emptyCells) {
      makeEmptyBoard();
      fillBoard(board);
      let full = board.map(r => r.slice());
      let attempts = emptyCells;
      while (attempts > 0) {
        let r = Math.floor(Math.random()*9);
        let c = Math.floor(Math.random()*9);
        if (board[r][c] !== 0) {
          let backup = board[r][c];
          board[r][c] = 0;
          let copy = board.map(r => r.slice());
          if (hasUniqueSolution(copy)) {
            attempts--;
          } else {
            board[r][c] = backup;
          }
        }
      }
      solution = full;
    }

    

    const sudokuDiv = document.getElementById("sudoku");
    const messageDiv = document.getElementById("message");
    const timerSpan = document.getElementById("timer");

    function drawBoard() {
      sudokuDiv.innerHTML = "";
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          let cell = document.createElement("div");
          cell.classList.add("cell");
          cell.dataset.r = r; cell.dataset.c = c;
          if (board[r][c] !== 0) {
            cell.textContent = board[r][c];
            cell.classList.add("fixed");
          }
          cell.addEventListener("click", () => selectCell(cell));
          sudokuDiv.appendChild(cell);
        }
      }
    }

    function selectCell(cell) {
      if (cell.classList.contains("fixed")) return;
      clearHighlights();
      selectedCell = cell;
      highlightRelated(cell);
      if (cell.textContent) highlightSameNumber(cell.textContent);
    }

    function clearHighlights() {
      sudokuDiv.querySelectorAll(".cell").forEach(c => {
        c.classList.remove("highlight", "same-number");
      });
    }

    function highlightRelated(cell) {
      const r = +cell.dataset.r, c = +cell.dataset.c;
      sudokuDiv.querySelectorAll(".cell").forEach(c2 => {
        let rr = +c2.dataset.r, cc = +c2.dataset.c;
        if (rr === r || cc === c ||
            (Math.floor(rr/3)==Math.floor(r/3) && Math.floor(cc/3)==Math.floor(c/3))) {
          c2.classList.add("highlight");
        }
      });
    }

    function highlightSameNumber(num) {
      sudokuDiv.querySelectorAll(".cell").forEach(c2 => {
        if (c2.textContent === num) c2.classList.add("same-number");
      });
    }

    function setCellValue(r, c, val, isNote) {
      let cell = sudokuDiv.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
      if (!cell || cell.classList.contains("fixed")) return;
      if (isNote) {
        // ÂØ¶‰ΩúÁ∞°ÂñÆÁ≠ÜË®òÔºöÈ°ØÁ§∫Â∞èÂ≠óÔºàÈÄôË£°ÁÇ∫Á§∫ÁØÑÔºåÂè™È°Ø‰∏ªË¶ÅÊï∏Â≠óÔºâ
        cell.textContent = val;
      } else {
        cell.textContent = val;
      }
      cell.classList.add("anim");
      historyStack.push(JSON.stringify(board));
      redoStack = [];
      board[r][c] = val;
      checkComplete();
    }

    function eraseCell(r, c) {
      let cell = sudokuDiv.querySelector(`.cell[data-r='${r}'][data-c='${c}']`);
      if (!cell || cell.classList.contains("fixed")) return;
      cell.textContent = "";
      historyStack.push(JSON.stringify(board));
      redoStack = [];
      board[r][c] = 0;
    }

    function undo() {
      if (historyStack.length === 0) return;
      redoStack.push(JSON.stringify(board));
      let prev = JSON.parse(historyStack.pop());
      board = prev;
      drawBoard();
    }

    function redo() {
      if (redoStack.length === 0) return;
      historyStack.push(JSON.stringify(board));
      let next = JSON.parse(redoStack.pop());
      board = next;
      drawBoard();
    }

    function checkComplete() {
      for (let r=0; r<9; r++)
        for (let c=0; c<9; c++)
          if (!board[r][c]) return;
      // ÂÖ®Êªø ‚Äî ÂÜçÊ™¢Êü•ÊòØÂê¶Ê≠£Á¢∫
      for (let r=0; r<9; r++)
        for (let c=0; c<9; c++)
          if (board[r][c] !== solution[r][c]) {
            return;
          }
      winAnimation();
      messageDiv.textContent = "üéâ ÊÅ≠ÂñúÂÆåÊàêÔºÅ";
      stopTimer();
    }

    function winAnimation() {
      for (let i = 0; i < 100; i++) {
        let conf = document.createElement("div");
        conf.classList.add("confetti");
        conf.style.left = Math.random()*100 + "vw";
        conf.style.background = `hsl(${Math.random()*360},80%,60%)`;
        document.body.appendChild(conf);
        conf.style.animation = `fall ${2 + Math.random()}s ease-out`;
        (function(el) {
          setTimeout(() => { document.body.removeChild(el); }, 3000);
        })(conf);
      }
    }

    

    document.getElementById("newGameBtn").addEventListener("click", () => {
      startNewGame();
    });
    document.getElementById("restartBtn").addEventListener("click", () => {
      drawBoard();
      historyStack = [];
      redoStack = [];
      board = board.map(r => r.slice());
    });
    document.getElementById("undoBtn").addEventListener("click", undo);
    document.getElementById("redoBtn").addEventListener("click", redo);
    document.getElementById("solveBtn").addEventListener("click", () => {
      board = solution.map(r => r.slice());
      drawBoard();
      stopTimer();
      messageDiv.textContent = "‚úî Ëá™ÂãïÂÆåÊàê";
    });

    document.getElementById("hintBtn").addEventListener("click", () => {
      // Á∞°ÂñÆÊèêÁ§∫ÔºöÊâæÂà∞Á¨¨‰∏ÄÂÄãÁ©∫Ê†º‰∏¶Â°´‰∏äÊ≠£Á¢∫Á≠îÊ°à
      for (let r = 0; r < 9; r++) {
        for (let c = 0; c < 9; c++) {
          if (board[r][c] === 0) {
            setCellValue(r, c, solution[r][c], false);
            return;
          }
        }
      }
    });

    document.getElementById("themeBtn").addEventListener("click", () => {
      themeDark = !themeDark;
      document.body.classList.toggle("light", !themeDark);
    });

    document.getElementById("noteToggle").addEventListener("click", () => {
      noteMode = !noteMode;
    });
    document.getElementById("eraseBtn").addEventListener("click", () => {
      if (!selectedCell) return;
      let r = +selectedCell.dataset.r, c = +selectedCell.dataset.c;
      eraseCell(r, c);
    });

    document.querySelectorAll("#numberPad .num").forEach(btn => {
      btn.addEventListener("click", () => {
        if (!selectedCell) return;
        let r = +selectedCell.dataset.r, c = +selectedCell.dataset.c;
        setCellValue(r, c, Number(btn.textContent), noteMode);
      });
    });

    window.addEventListener("keydown", (e) => {
      if (!selectedCell) return;
      let val = null;
      if (e.key >= '1' && e.key <= '9') val = Number(e.key);
      else if (e.key === 'Backspace' || e.key === 'Delete') val = 0;
      if (val !== null) {
        let r = +selectedCell.dataset.r, c = +selectedCell.dataset.c;
        if (val === 0) eraseCell(r, c);
        else setCellValue(r, c, val, noteMode);
      }
    });

    
    function startTimer() {
      clearInterval(timerInterval);
      startTime = Date.now();
      timerInterval = setInterval(() => {
        let diff = Date.now() - startTime;
        let m = Math.floor(diff / 60000);
        let s = Math.floor((diff % 60000) / 1000);
        timerSpan.textContent = (m<10?'0':'')+m + ":" + (s<10?'0':'')+s;
      }, 1000);
    }
    function stopTimer() {
      clearInterval(timerInterval);
    }

    

    function startNewGame() {
      let empties = Number(document.getElementById("difficulty").value);
      generatePuzzle(empties);
      drawBoard();
      historyStack = [];
      redoStack = [];
      messageDiv.textContent = "";
      startTimer();
    }

    
    startNewGame();

  </script>

</body>
</html>
