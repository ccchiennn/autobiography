<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŠæˆ²å»³</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.11/dist/contrib/auto-render.min.js"></script>

    <style>
        :root {
            --primary: #00f2fe;
            --secondary: #4facfe;
            --accent: #f9d423;
            --danger: #ff416c;
            --success: #00ff88;
            --bg: #070a13;
            --glass: rgba(255, 255, 255, 0.05);
        }

        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'PingFang TC', sans-serif;
            background: var(--bg); color: white; margin: 0;
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; overflow-x: hidden;
        }

        /* --- ä¸»ç•«é¢ Welcome Screen --- */
        #welcome-screen {
            position: fixed; inset: 0; background: radial-gradient(circle at center, #1e293b 0%, #020617 100%);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999;
        }
        .welcome-title span { display: block; font-size: 5rem; font-weight: 900; text-transform: uppercase; letter-spacing: 10px; line-height: 1.1; }
        .title-mid { background: linear-gradient(to right, #ff00de, var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .start-btn {
            margin-top: 40px; background: linear-gradient(45deg, var(--secondary), var(--primary));
            border: none; padding: 20px 60px; color: white; font-size: 1.5rem; font-weight: bold;
            border-radius: 100px; cursor: pointer; box-shadow: 0 0 30px rgba(0, 242, 254, 0.4); transition: 0.3s;
        }
        .start-btn:hover { transform: scale(1.1); box-shadow: 0 0 50px var(--primary); }

        /* --- Header & Nav --- */
        header {
            width: 100%; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px);
            padding: 15px 0; position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid rgba(255,255,255,0.1); display: none;
        }
        .nav-container { max-width: 1100px; margin: 0 auto; display: flex; justify-content: space-around; align-items: center; width: 100%; }
        .coin-display { font-size: 1.4rem; color: var(--accent); font-weight: bold; background: rgba(0,0,0,0.4); padding: 5px 20px; border-radius: 30px; }
        .nav-link { background: transparent; border: none; color: #94a3b8; font-size: 1.1rem; font-weight: bold; cursor: pointer; transition: 0.3s; }
        .nav-link.active { color: var(--primary); border-bottom: 3px solid var(--primary); }

        /* --- Game Main --- */
        .game-main { width: 95%; max-width: 1000px; margin: 30px 0; display: none; }
        .game-card { display: none; background: #111827; border-radius: 40px; padding: 40px; box-shadow: 0 30px 60px rgba(0,0,0,0.6); }
        .game-card.active { display: block; animation: fadeInUp 0.5s ease forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

        /* --- AI Chat --- */
        #chat-box { height: 500px; overflow-y: auto; background: rgba(0,0,0,0.3); border-radius: 20px; padding: 20px; display: flex; flex-direction: column; gap: 12px; border: 1px solid #334155; }
        .msg { max-width: 80%; padding: 12px 18px; border-radius: 18px; font-size: 15px; line-height: 1.6; }
        .user-msg { align-self: flex-end; background: #8dd7a5; color: #083d18; border-bottom-right-radius: 4px; }
        .bot-msg { align-self: flex-start; background: #ffffff; color: #1d3e2e; border-bottom-left-radius: 4px; }
        .input-bar { display: flex; gap: 10px; margin-top: 20px; }
        #ai-input { flex: 1; background: #1f2937; border: 1px solid #374151; color: white; padding: 15px; border-radius: 15px; resize: none; }

        /* --- éŠæˆ²ç´°ç¯€æ¨£å¼ --- */
        #react-pad { width: 100%; height: 350px; background: #1f2937; border-radius: 25px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; border: 4px solid #374151; }
        .race-track { background: #000; padding: 20px; border-radius: 20px; }
        .lane { height: 90px; border-bottom: 1px dashed #334151; position: relative; display: flex; align-items: center; }
        .horse { font-size: 4rem; position: absolute; left: 0; transition: 0.1s; }
        #f-canvas { background: #000; border-radius: 20px; width: 100%; height: 450px; cursor: crosshair; }
        .dice-wrap { display: flex; justify-content: center; gap: 40px; margin: 30px 0; }
        .dice-box { width: 110px; height: 110px; background: white; color: black; border-radius: 20px; display: flex; justify-content: center; align-items: center; font-size: 3.5rem; font-weight: bold; box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <h1 class="welcome-title">
            <span style="color:var(--primary)">Welcome</span>
            <span class="title-mid">To Game</span>
            <span style="color:var(--secondary)">Station</span>
        </h1>
        <input id="api-key" type="password" placeholder="è²¼ä¸Šä½ çš„ Gemini API Key" style="margin-top:30px; padding:12px; width:300px; border-radius:15px; border:none; text-align:center; font-size:1rem;">
        <button class="start-btn" onclick="startApp()">é€²å…¥éŠæˆ²å»³</button>
    </div>

    <header id="header">
        <div class="nav-container">
            <button class="nav-link active" onclick="tab('react', this)">åæ‡‰æŒ‘æˆ°</button>
            <button class="nav-link" onclick="tab('race', this)">çš‡å®¶è³½é¦¬</button>
            <button class="nav-link" onclick="tab('fruit', this)">å¿è€…ç æœ</button>
            <button class="nav-link" onclick="tab('dice', this)">éª°å­å¤§è³½</button>
            <button class="nav-link" onclick="tab('chat', this)" style="color:var(--success)">AI åŠ©æ•™</button>
            <div class="coin-display">ğŸ’° <span id="coins">1000</span></div>
        </div>
    </header>

    <div class="game-main" id="main">
        <div id="react" class="game-card active">
            <h2 style="text-align:center">ç¥ç¶“åæ‡‰æ¸¬è©¦</h2>
            <div id="react-pad" onclick="reactClick()">
                <p id="r-main" style="font-size:5rem; font-weight:900; margin:0;">START</p>
                <p id="r-rank" style="font-size:2rem; color:var(--accent); font-weight:bold;"></p>
            </div>
            <p style="text-align:center; margin-top:20px; color:#94a3b8;">é»æ“Šè‰²å¡Šé–‹å§‹æ¸¬è©¦åæ‡‰é€Ÿåº¦</p>
        </div>

        <div id="race" class="game-card">
            <h2 style="text-align:center">çš‡å®¶å¤§è³½é¦¬</h2>
            <div style="text-align:center; margin-bottom:20px;">
                ä¸‹æ³¨: <input type="number" id="bet" value="100" style="width:80px; padding:8px; border-radius:10px;">
                é æ¸¬: <select id="h-select" style="padding:8px; border-radius:10px;"><option value="0">1è™Ÿ ğŸ</option><option value="1">2è™Ÿ ğŸ¦„</option><option value="2">3è™Ÿ ğŸ¦“</option></select>
                <button onclick="raceStart()" class="start-btn" style="padding:10px 30px; font-size:1rem; margin-left:10px; margin-top:0;">é–‹è³½</button>
            </div>
            <div class="race-track">
                <div class="lane"><div class="horse" id="h0">ğŸ</div></div>
                <div class="lane"><div class="horse" id="h1">ğŸ¦„</div></div>
                <div class="lane"><div class="horse" id="h2">ğŸ¦“</div></div>
            </div>
        </div>

        <div id="fruit" class="game-card">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <span style="font-size:1.5rem">å¾—åˆ†: <span id="f-score">0</span></span>
                <span style="font-size:1.5rem">å€’æ•¸: <span id="f-timer">30</span>s</span>
            </div>
            <canvas id="f-canvas"></canvas>
            <center><button onclick="fruitInit()" class="start-btn" style="margin-top:20px; padding:10px 40px;">é–‹å§‹éŠæˆ²</button></center>
        </div>

        <div id="dice" class="game-card">
            <h2 style="text-align:center">æ“²éª°å¤§è³½</h2>
            <div class="dice-wrap">
                <div class="dice-box" id="u-d">?</div>
                <div style="font-size:3rem; align-self:center;">VS</div>
                <div class="dice-box" id="c-d">?</div>
            </div>
            <center><button onclick="dicePlay()" class="start-btn" style="width:300px;">æ“²éª°å­ (ä¸‹æ³¨200)</button></center>
            <p id="d-msg" style="text-align:center; font-size:1.5rem; margin-top:20px; color:var(--accent); font-weight:bold;"></p>
        </div>

        <div id="chat" class="game-card">
            <div id="chat-box"></div>
            <div class="input-bar">
                <input type="file" id="ai-file" style="width:100px; font-size:10px;">
                <textarea id="ai-input" placeholder="å•å• AI åŠ©æ•™é—œæ–¼éŠæˆ²æˆ–ä»»ä½•äº‹..."></textarea>
                <button onclick="aiSend()" class="start-btn" style="margin-top:0; padding:0 30px; font-size:1.2rem;">é€å‡º</button>
            </div>
        </div>
    </div>

<script>
    let coins = 1000, key = "", conv = [];
    function startApp() {
        key = document.getElementById('api-key').value.trim();
        if(!key) return alert("è«‹è¼¸å…¥ API Key");
        document.getElementById('welcome-screen').style.display='none';
        document.getElementById('header').style.display='block';
        document.getElementById('main').style.display='block';
        updateUI();
    }
    function updateUI() { document.getElementById('coins').innerText = coins; }
    function tab(id, btn) {
        document.querySelectorAll('.game-card').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        btn.classList.add('active');
    }

    // --- åæ‡‰æŒ‘æˆ° ---
    let rs = 'idle', rtimer, rstart;
    function reactClick() {
        const p = document.getElementById('react-pad'), m = document.getElementById('r-main'), r = document.getElementById('r-rank');
        if(rs === 'idle') {
            rs = 'wait'; p.style.background = '#eab308'; m.innerText = 'WAIT...'; r.innerText = '';
            rtimer = setTimeout(() => { rs = 'go'; p.style.background = '#22c55e'; m.innerText = 'GO!!'; rstart = Date.now(); }, Math.random()*3000+2000);
        } else if(rs === 'wait') {
            clearTimeout(rtimer); rs = 'idle'; p.style.background = '#ef4444'; m.innerText = 'TOO EARLY!';
        } else if(rs === 'go') {
            const diff = Date.now() - rstart; rs = 'idle'; p.style.background = '#1f2937'; m.innerText = diff+'ms';
            let rank = diff < 200 ? 'ç¥ä¹‹åæ‡‰âš¡' : diff < 300 ? 'å‡¡äººğŸš¶' : diff < 500 ? 'ç·©æ…¢ğŸ¢' : 'æ¨¹æ‡¶ğŸ—¿';
            r.innerText = rank; coins += diff < 300 ? 50 : 10; updateUI();
        }
    }

    // --- è³½é¦¬ ---
    let racing = false;
    function raceStart() {
        const bet = parseInt(document.getElementById('bet').value);
        if(racing || coins < bet) return; coins -= bet; updateUI(); racing = true;
        let pos = [0,0,0], hs = [document.getElementById('h0'),document.getElementById('h1'),document.getElementById('h2')];
        let int = setInterval(() => {
            for(let i=0; i<3; i++) {
                pos[i] += Math.random()*3.5; hs[i].style.left = pos[i]+'%';
                if(pos[i] >= 90) {
                    clearInterval(int); racing = false;
                    const win = (i == document.getElementById('h-select').value);
                    if(win) coins += bet*3;
                    alert("å† è»æ˜¯ "+(i+1)+" è™Ÿï¼" + (win ? " ä½ è´äº†ï¼" : ""));
                    updateUI(); setTimeout(()=>hs.forEach(h=>h.style.left='0'), 1000);
                }
            }
        }, 50);
    }

    // --- ç æ°´æœ  ---
    const canvas = document.getElementById('f-canvas'); const ctx = canvas.getContext('2d');
    let fruits = [], fActive = false, fScore = 0, fTime = 30;
    function fruitInit() {
        if(fActive) return; fActive = true; fScore = 0; fTime = 30; fruits = [];
        canvas.width = canvas.offsetWidth; canvas.height = canvas.offsetHeight;
        let tInt = setInterval(() => {
            fTime--; document.getElementById('f-timer').innerText = fTime;
            if(fTime <= 0) { clearInterval(tInt); fActive = false; coins += fScore; updateUI(); alert("éŠæˆ²çµæŸï¼ç²å¾— " + fScore + " é‡‘å¹£"); }
        }, 1000);
        fRender();
    }
    canvas.onmousemove = (e) => {
        if(!fActive) return; const r = canvas.getBoundingClientRect(), mx = e.clientX-r.left, my = e.clientY-r.top;
        fruits.forEach(f => {
            if(Math.hypot(f.x-mx, f.y-my) < 45 && !f.c) {
                f.c = true; if(f.t === 'b') { fScore -= 50; } else { fScore += 15; }
                document.getElementById('f-score').innerText = fScore;
            }
        });
    };
    function fRender() {
        if(!fActive) return; ctx.clearRect(0,0,canvas.width,canvas.height);
        if(Math.random() < 0.03) fruits.push({x: Math.random()*canvas.width, y: canvas.height, vy: -7, vx: (Math.random()-0.5)*3, t: Math.random()<0.15?'b':'f', c: false});
        fruits.forEach((f, i) => {
            f.x += f.vx; f.y += f.vy; f.vy += 0.12; ctx.font = '45px Arial';
            if(!f.c) ctx.fillText(f.t==='b'?'ğŸ’£':'ğŸ', f.x, f.y);
            else if(f.t==='f') ctx.fillText('âœ¨', f.x, f.y);
            if(f.y > canvas.height + 50) fruits.splice(i, 1);
        });
        requestAnimationFrame(fRender);
    }

    // --- éª°å­ ---
    function dicePlay() {
        if(coins < 200) return alert("é‡‘å¹£ä¸è¶³");
        const ud = document.getElementById('u-d'), cd = document.getElementById('c-d'), msg = document.getElementById('d-msg');
        msg.innerText = "æ“²éª°ä¸­...";
        setTimeout(() => {
            const u = Math.floor(Math.random()*6)+1, c = Math.floor(Math.random()*6)+1;
            ud.innerText = u; cd.innerText = c;
            if(u > c) { coins += 200; msg.innerText = "YOU WIN! +200"; }
            else if(u < c) { coins -= 200; msg.innerText = "YOU LOSE! -200"; }
            else { msg.innerText = "DRAW! å¹³æ‰‹"; }
            updateUI();
        }, 600);
    }

    // --- AI åŠ©æ•™ ---
    async function aiSend() {
        const inp = document.getElementById('ai-input'), file = document.getElementById('ai-file');
        const text = inp.value.trim(); if(!text && !file.files[0]) return;
        addMsg(text || "ï¼ˆä¸Šå‚³æª”æ¡ˆï¼‰", 'user-msg'); inp.value = "";
        const think = addMsg("AI åŠ©æ•™æ€è€ƒä¸­...", 'bot-msg');
        try {
            let parts = [{text}];
            if(file.files[0]) {
                const b64 = await new Promise(r => { const rd = new FileReader(); rd.onload=()=>r(rd.result.split(',')[1]); rd.readAsDataURL(file.files[0]); });
                parts.push({inlineData: {data: b64, mimeType: file.files[0].type}});
            }
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`, {
                method: "POST", headers: {"Content-Type": "application/json"},
                body: JSON.stringify({contents: [...conv, {role:"user", parts}]})
            });
            const data = await res.json(); const reply = data.candidates[0].content.parts[0].text;
            think.innerHTML = marked.parse(reply);
            conv.push({role:"user", parts:[{text}]}, {role:"model", parts:[{text:reply}]});
            if(conv.length > 10) conv.shift();
            renderMathInElement(think, {delimiters: [{left:"$", right:"$", display:false}, {left:"$$", right:"$$", display:true}]});
        } catch(e) { think.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Key"; }
        document.getElementById('chat-box').scrollTop = 99999;
    }
    function addMsg(h, t) {
        const d = document.createElement("div"); d.className = "msg " + t; d.innerHTML = h;
        document.getElementById('chat-box').appendChild(d); document.getElementById('chat-box').scrollTop = 99999; return d;
    }
</script>
</body>
</html>
