<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç²¾ç·»æ•¸ç¨éŠæˆ² (é›£åº¦å¯èª¿èˆ‡é«˜äº®æ•¸å­—)</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* å…¨å±€æ¨£å¼å’Œå­—é«”è¨­å®š */
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f0f4f8;
            color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        .container {
            background: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 100%;
            max-width: 500px;
        }

        h1 {
            color: #4a90e2;
            margin-bottom: 25px;
            font-weight: 700;
        }

        /* æ•¸ç¨ç¶²æ ¼æ¨£å¼ */
        .sudoku-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            grid-template-rows: repeat(9, 1fr);
            width: 90%;
            max-width: 450px;
            margin: 0 auto 20px auto;
            border: 4px solid #333;
            aspect-ratio: 1 / 1;
            background-color: #eee;
        }

        .cell {
            border: 1px solid #ccc;
            font-size: 1.5em;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
            user-select: none;
        }

        /* çªå‡ºé¡¯ç¤º 3x3 ä¹å®®æ ¼çš„é‚Šç•Œ */
        .cell:nth-child(3n) {
            border-right-width: 3px;
            border-right-color: #333;
        }
        .cell:nth-child(27n) {
            border-bottom-width: 3px;
            border-bottom-color: #333;
        }
        /* æ¯ä¸€è¡Œçš„ç¬¬ä¸‰å€‹å’Œç¬¬å…­å€‹å–®å…ƒæ ¼ */
        .cell:nth-child(9n+1):nth-child(3n) {
            border-right-width: 1px;
            border-right-color: #ccc;
        }
        /* æ¯ä¸€è¡Œæœ«å°¾çš„é‚Šç•Œ */
        .cell:nth-child(9n) {
            border-right-width: 4px;
            border-right-color: #333;
        }
        /* æ•¸ç¨æ¿æœ€å¾Œä¸€è¡Œçš„é‚Šç•Œ */
        .cell:nth-last-child(-n+9) {
            border-bottom-width: 4px;
            border-bottom-color: #333;
        }
        /* æ•¸ç¨æ¿å·¦å´é‚Šç•Œ */
        .cell:nth-child(9n+1) {
            border-left-width: 4px;
            border-left-color: #333;
        }
        /* æ•¸ç¨æ¿é ‚éƒ¨é‚Šç•Œ */
        .cell:nth-child(-n+9) {
            border-top-width: 4px;
            border-top-color: #333;
        }


        /* å–®å…ƒæ ¼ç‹€æ…‹ */
        .given {
            background-color: #ddd;
            color: #2c3e50;
            cursor: default;
            font-weight: 700;
        }

        .selected {
            background-color: #ffeaa7; /* é¸ä¸­çš„å–®å…ƒæ ¼ */
            box-shadow: inset 0 0 0 2px #fbc531;
        }
        
        /* æ–°å¢ï¼šç›¸åŒæ•¸å­—é«˜äº® */
        .same-number-highlight {
            background-color: #e6e6fa; /* æ·ºç´«è‰² */
            color: #4a90e2; 
        }

        .highlighted {
            background-color: #f1f8ff; /* åŒè¡Œ/åˆ—/å®®æ ¼é«˜äº® */
        }

        .error {
            background-color: #ff7675 !important;
            color: white;
        }

        .inputted {
            color: #4a90e2;
        }

        /* é›£åº¦é¸æ“‡å€å¡Š */
        .difficulty-selector {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
        }

        .difficulty-selector label {
            margin-right: 10px;
            color: #555;
        }

        .difficulty-selector select {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #ccc;
            background-color: white;
            font-size: 1em;
            cursor: pointer;
            outline: none;
            transition: border-color 0.2s;
        }

        .difficulty-selector select:focus {
            border-color: #4a90e2;
        }

        /* æ•¸å­—æ§åˆ¶å€æ¨£å¼ */
        .number-controls {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .num-btn {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 10px 0;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .num-btn:hover {
            background-color: #3872c0;
        }

        .num-btn:active {
            transform: scale(0.98);
        }

        /* åŠŸèƒ½æŒ‰éˆ•å€æ¨£å¼ */
        .action-buttons {
            display: flex;
            justify-content: space-around;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s, opacity 0.2s;
        }

        #new-game-btn {
            background-color: #2ecc71;
            color: white;
        }
        #new-game-btn:hover { background-color: #27ae60; }

        .clear-btn {
            background-color: #f39c12;
            color: white;
        }
        .clear-btn:hover { background-color: #e67e22; }

        .check-btn {
            background-color: #3498db;
            color: white;
        }
        .check-btn:hover { background-color: #2980b9; }

        /* è¨Šæ¯å€æ¨£å¼ */
        .message-area {
            min-height: 30px;
            font-size: 1.1em;
            font-weight: 700;
            padding: 10px;
            border-radius: 8px;
        }

        .success-message {
            color: #2ecc71;
            background-color: #e8f8f5;
        }

        .error-message {
            color: #e74c3c;
            background-color: #fdeaea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ¨ ç¶“å…¸æ•¸ç¨ âœ¨</h1>
        
        <div class="difficulty-selector">
            <label for="difficulty">é¸æ“‡é›£åº¦:</label>
            <select id="difficulty">
                <option value="easy">ç°¡å–®</option>
                <option value="medium" selected>ä¸­ç­‰</option>
                <option value="hard">å›°é›£</option>
            </select>
        </div>

        <div id="sudoku-grid" class="sudoku-grid">
            </div>

        <div id="number-controls" class="number-controls">
            </div>

        <div class="action-buttons">
            <button id="new-game-btn" class="btn">ç”Ÿæˆæ–°éŠæˆ²</button>
            <button id="clear-btn" class="btn clear-btn">æ¸…é™¤å–®å…ƒæ ¼</button>
            <button id="check-btn" class="btn check-btn">æª¢æŸ¥ç­”æ¡ˆ</button>
        </div>

        <div id="message-area" class="message-area"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const gridElement = document.getElementById('sudoku-grid');
            const controlsElement = document.getElementById('number-controls');
            const messageArea = document.getElementById('message-area');
            const newGameBtn = document.getElementById('new-game-btn');
            const clearBtn = document.getElementById('clear-btn');
            const checkBtn = document.getElementById('check-btn');
            const difficultySelector = document.getElementById('difficulty'); // æ–°å¢é›£åº¦é¸æ“‡å™¨ DOM

            // é›£åº¦å°æ‡‰è¦ç§»é™¤çš„æ•¸å­—æ•¸é‡ (æŒ–ç©ºæ•¸)
            const DIFFICULTY_LEVELS = {
                'easy': 35,    // ç°¡å–®ï¼šç´„ 46 å€‹çµ¦å®šæ•¸å­—
                'medium': 45,  // ä¸­ç­‰ï¼šç´„ 36 å€‹çµ¦å®šæ•¸å­—
                'hard': 55     // å›°é›£ï¼šç´„ 26 å€‹çµ¦å®šæ•¸å­— (ç¢ºä¿å”¯ä¸€è§£ï¼Œå¯èƒ½ç•¥æœ‰æ³¢å‹•)
            };

            let currentSudoku = []; // éŠæˆ²çš„ç•¶å‰ç‹€æ…‹ (9x9 é™£åˆ—)
            let solvedSudoku = [];  // éŠæˆ²çš„å”¯ä¸€è§£ (9x9 é™£åˆ—)
            let selectedCell = null; // ç•¶å‰é¸ä¸­çš„å–®å…ƒæ ¼

            // --- I. æ•¸ç¨æ ¸å¿ƒæ¼”ç®—æ³• ---

            function shuffle(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }

            function isSafe(board, row, col, num) {
                // æª¢æŸ¥è¡Œã€åˆ—ã€3x3 ä¹å®®æ ¼
                for (let d = 0; d < 9; d++) {
                    if (board[row][d] === num) return false;
                }
                for (let r = 0; r < 9; r++) {
                    if (board[r][col] === num) return false;
                }
                const boxRowStart = row - row % 3;
                const boxColStart = col - col % 3;
                for (let r = 0; r < 3; r++) {
                    for (let d = 0; d < 3; d++) {
                        if (board[boxRowStart + r][boxColStart + d] === num) return false;
                    }
                }
                return true;
            }

            function solveSudoku(board) {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) {
                            const numbers = shuffle([1, 2, 3, 4, 5, 6, 7, 8, 9]);
                            for (const num of numbers) {
                                if (isSafe(board, row, col, num)) {
                                    board[row][col] = num;
                                    if (solveSudoku(board)) return true;
                                    board[row][col] = 0; // å›æº¯
                                }
                            }
                            return false;
                        }
                    }
                }
                return true;
            }

            let solutionsCount = 0;
            function countSolutions(board) {
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        if (board[row][col] === 0) {
                            for (let num = 1; num <= 9; num++) {
                                if (isSafe(board, row, col, num)) {
                                    board[row][col] = num;
                                    countSolutions(board);
                                    board[row][col] = 0;
                                    if (solutionsCount > 1) return;
                                }
                            }
                            return;
                        }
                    }
                }
                solutionsCount++;
            }

            // --- æ–°å¢ï¼šé›£åº¦èª¿æ•´é‚è¼¯ ---
            function getCellsToRemove(difficulty) {
                return DIFFICULTY_LEVELS[difficulty] || DIFFICULTY_LEVELS.medium;
            }

            function generateSudoku(difficulty) {
                const cellsToRemove = getCellsToRemove(difficulty);

                let fullBoard = Array.from({ length: 9 }, () => Array(9).fill(0));
                solveSudoku(fullBoard);
                solvedSudoku = JSON.parse(JSON.stringify(fullBoard)); 

                let puzzleBoard = JSON.parse(JSON.stringify(fullBoard));
                let cellsLeft = cellsToRemove;

                let allCells = Array.from({ length: 81 }, (_, i) => i);
                shuffle(allCells);

                for(let i = 0; i < allCells.length && cellsLeft > 0; i++) {
                    const index = allCells[i];
                    const r = Math.floor(index / 9);
                    const c = index % 9;

                    const temp = puzzleBoard[r][c];
                    if (temp === 0) continue;

                    puzzleBoard[r][c] = 0;
                    
                    solutionsCount = 0;
                    countSolutions(JSON.parse(JSON.stringify(puzzleBoard)));

                    if (solutionsCount === 1) {
                        cellsLeft--;
                    } else {
                        puzzleBoard[r][c] = temp;
                    }
                }

                currentSudoku = puzzleBoard;
                return puzzleBoard;
            }


            // --- II. éŠæˆ²ä»‹é¢èˆ‡äº’å‹• (åŒ…å«é«˜äº®ç›¸åŒæ•¸å­—) ---

            function renderGrid(board) {
                gridElement.innerHTML = '';
                board.flat().forEach((value, index) => {
                    const r = Math.floor(index / 9);
                    const c = index % 9;
                    const cell = document.createElement('div');
                    
                    cell.classList.add('cell');
                    cell.dataset.row = r;
                    cell.dataset.col = c;
                    cell.dataset.value = value; // å„²å­˜å€¼ä»¥ä¾¿é«˜äº®

                    if (value !== 0) {
                        cell.textContent = value;
                        cell.classList.add('given');
                    } else {
                        cell.textContent = '';
                        cell.classList.add('input-cell');
                    }
                    cell.addEventListener('click', handleCellClick);
                    gridElement.appendChild(cell);
                });
            }

            function renderControls() {
                controlsElement.innerHTML = '';
                for (let i = 1; i <= 9; i++) {
                    const button = document.createElement('button');
                    button.classList.add('num-btn');
                    button.textContent = i;
                    button.dataset.value = i;
                    button.addEventListener('click', handleControlClick);
                    controlsElement.appendChild(button);
                }
            }
            
            // æ–°å¢ï¼šé«˜äº®æ‰€æœ‰å…·æœ‰ç›¸åŒæ•¸å­—çš„å–®å…ƒæ ¼
            function highlightSameNumbers(value) {
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('same-number-highlight');
                });

                if (value !== 0 && value !== '') {
                    document.querySelectorAll(`.cell[data-value="${value}"]`).forEach(cell => {
                        // ç¢ºä¿åªæœ‰éé¸ä¸­å–®å…ƒæ ¼æ‰ä½¿ç”¨ general highlight
                        if (!cell.classList.contains('selected')) { 
                            cell.classList.add('same-number-highlight');
                        }
                    });
                }
            }


            // è™•ç†å–®å…ƒæ ¼é»æ“Š (åŠ å…¥é«˜äº®ç›¸åŒæ•¸å­—çš„é‚è¼¯)
            function handleCellClick(event) {
                const newSelected = event.target;

                // 1. æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œé¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('selected', 'highlighted', 'same-number-highlight');
                });

                // 2. è¨­å®šæ–°çš„é¸ä¸­ç‹€æ…‹
                selectedCell = newSelected;
                selectedCell.classList.add('selected');

                // 3. é«˜äº®åŒè¡Œã€åŒåˆ—ã€åŒä¹å®®æ ¼
                const r = parseInt(selectedCell.dataset.row);
                const c = parseInt(selectedCell.dataset.col);
                
                document.querySelectorAll('.cell').forEach(cell => {
                    const row = parseInt(cell.dataset.row);
                    const col = parseInt(cell.dataset.col);

                    const isSameRow = row === r;
                    const isSameCol = col === c;
                    const isSameBox = (Math.floor(row / 3) === Math.floor(r / 3)) && 
                                      (Math.floor(col / 3) === Math.floor(c / 3));

                    if (isSameRow || isSameCol || isSameBox) {
                        cell.classList.add('highlighted');
                    }
                });
                
                // 4. é«˜äº®æ‰€æœ‰ç›¸åŒçš„æ•¸å­—
                const cellValue = selectedCell.textContent ? parseInt(selectedCell.textContent) : 0;
                if (cellValue !== 0) {
                     highlightSameNumbers(cellValue);
                }

                messageArea.textContent = '';
                messageArea.className = 'message-area';
            }

            // è™•ç†æ•¸å­—æŒ‰éˆ•é»æ“Š
            function handleControlClick(event) {
                if (!selectedCell || selectedCell.classList.contains('given')) return;

                const value = parseInt(event.target.dataset.value);
                const r = parseInt(selectedCell.dataset.row);
                const c = parseInt(selectedCell.dataset.col);

                // è¨­ç½®å–®å…ƒæ ¼çš„å€¼
                selectedCell.textContent = value;
                selectedCell.classList.add('inputted');
                selectedCell.classList.remove('error');
                selectedCell.dataset.value = value; // æ›´æ–° dataset.value

                // æ›´æ–°éŠæˆ²æ•¸æ“š
                currentSudoku[r][c] = value;

                checkCellForErrors();

                // é»æ“Šæ•¸å­—å¾Œä¹ŸåŸ·è¡Œé«˜äº®ç›¸åŒæ•¸å­—
                highlightSameNumbers(value); 

                if (isGameCompleted()) {
                    showMessage('æ­å–œï¼æ‚¨å®Œæˆäº†ä¸€å€‹å®Œç¾æ•¸ç¨ï¼', 'success');
                }
            }
            
            function checkCellForErrors() {
                // 1. æ¸…é™¤æ‰€æœ‰éŒ¯èª¤ç‹€æ…‹
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('error');
                });
                
                // 2. é‡æ–°æª¢æŸ¥æ‰€æœ‰è¼¸å…¥çš„æ•¸å­—
                for (let row = 0; row < 9; row++) {
                    for (let col = 0; col < 9; col++) {
                        const tempValue = currentSudoku[row][col];
                        
                        if (tempValue !== 0) {
                            currentSudoku[row][col] = 0; 
                            
                            if (!isSafe(currentSudoku, row, col, tempValue)) {
                                document.querySelector(`.cell[data-row="${row}"][data-col="${col}"]`).classList.add('error');
                            }
                            
                            currentSudoku[row][col] = tempValue;
                        }
                    }
                }
            }
            
            function isGameCompleted() {
                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        if (currentSudoku[r][c] === 0 || document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`).classList.contains('error')) {
                            return false;
                        }
                    }
                }
                return true;
            }

            function showMessage(text, type) {
                messageArea.textContent = text;
                messageArea.className = `message-area ${type}-message`;
            }

            // --- III. åŠŸèƒ½æŒ‰éˆ•é‚è¼¯ ---

            // è™•ç†ã€Œé‡æ–°é–‹å§‹ã€æŒ‰éˆ•ï¼Œç¾åœ¨æœƒæ ¹æ“šé›£åº¦é¸æ“‡å™¨ç”ŸæˆéŠæˆ²
            newGameBtn.addEventListener('click', () => {
                const selectedDifficulty = difficultySelector.value;
                initGame(selectedDifficulty);
                showMessage(`å·²ç”Ÿæˆ ${selectedDifficulty} é›£åº¦çš„æ•¸ç¨è¬é¡Œï¼`, 'success');
            });

            // è™•ç†ã€Œæ¸…é™¤ã€
            clearBtn.addEventListener('click', () => {
                if (!selectedCell || selectedCell.classList.contains('given')) return;
                
                const r = parseInt(selectedCell.dataset.row);
                const c = parseInt(selectedCell.dataset.col);
                
                selectedCell.textContent = '';
                selectedCell.classList.remove('inputted', 'error');
                selectedCell.dataset.value = 0; // æ¸…é™¤ dataset.value
                currentSudoku[r][c] = 0;
                
                // æ¸…é™¤ç›¸åŒæ•¸å­—é«˜äº® (å› ç‚ºæ•¸å­—è¢«ç§»é™¤äº†)
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('same-number-highlight');
                });

                checkCellForErrors(); 
                showMessage('å–®å…ƒæ ¼å…§å®¹å·²æ¸…é™¤ã€‚', 'error');
            });

            // è™•ç†ã€Œæª¢æŸ¥ç­”æ¡ˆã€
            checkBtn.addEventListener('click', () => {
                let hasError = false;
                let isComplete = true;

                document.querySelectorAll('.cell').forEach(cell => cell.classList.remove('error'));

                for (let r = 0; r < 9; r++) {
                    for (let c = 0; c < 9; c++) {
                        const value = currentSudoku[r][c];
                        const cellElement = document.querySelector(`.cell[data-row="${r}"][data-col="${c}"]`);

                        if (value === 0) {
                            isComplete = false;
                            continue;
                        }

                        if (value !== solvedSudoku[r][c]) {
                            cellElement.classList.add('error');
                            hasError = true;
                        }
                    }
                }

                if (hasError) {
                    showMessage('ç³Ÿç³•ï¼Œæœ‰äº›æ•¸å­—ä¸æ­£ç¢ºï¼è«‹æŸ¥çœ‹ç´…è‰²æ¨™è¨˜ã€‚', 'error');
                } else if (isComplete) {
                    showMessage('å®Œç¾ï¼æ‚¨çš„è§£ç­”å®Œå…¨æ­£ç¢ºï¼ğŸ‰', 'success');
                } else {
                    showMessage('ç›®å‰æ²’æœ‰éŒ¯èª¤ï¼Œè«‹ç¹¼çºŒåŠ æ²¹ï¼ğŸ’ª', 'success');
                }
            });

            // æ–°å¢ï¼šé›£åº¦é¸æ“‡å™¨äº‹ä»¶ï¼Œé¸æ“‡å¾Œç«‹åˆ»ç”Ÿæˆæ–°éŠæˆ²
            difficultySelector.addEventListener('change', (event) => {
                 initGame(event.target.value);
                 showMessage(`é›£åº¦å·²åˆ‡æ›ç‚º ${event.target.options[event.target.selectedIndex].text}ï¼Œæ–°éŠæˆ²å·²ç”Ÿæˆï¼`, 'success');
            });


            // --- IV. éŠæˆ²åˆå§‹åŒ– ---

            // ç¾åœ¨æ¥å—é›£åº¦ä½œç‚ºåƒæ•¸
            function initGame(difficulty = 'medium') {
                document.querySelectorAll('.cell').forEach(cell => {
                    cell.classList.remove('selected', 'highlighted', 'same-number-highlight', 'error');
                });
                
                generateSudoku(difficulty);
                renderGrid(currentSudoku);
                renderControls();
                
                selectedCell = null;
                messageArea.textContent = '';
                messageArea.className = 'message-area';
            }

            // å•Ÿå‹•éŠæˆ² (ä½¿ç”¨ä¸­ç­‰é›£åº¦ä½œç‚ºé è¨­)
            initGame('medium');
        });
    </script>
</body>
</html>
